services:
  scraper:
    # Build from the Dockerfile in the current directory
    # (This ensures we get the custom 6.1.3 driver installation)
    build: 
      context: .
      dockerfile: Dockerfile
    
    container_name: rocm_scraper
    restart: unless-stopped
    
    # Required for PyTorch dataloaders to share memory without crashing
    shm_size: '8gb'

    environment:
      # 1. THE BRIDGE FIX: Point PyTorch to the 6.1.3 driver folder first
      # We found this path in the previous step (/opt/rocm-6.1.3/lib)
      - LD_LIBRARY_PATH=/opt/rocm-6.1.3/lib:/opt/rocm/lib:/usr/local/lib

      # 2. Force RDNA3 identity (Required for 7900 XT)
      - HSA_OVERRIDE_GFX_VERSION=11.0.0
      
      # 3. CRITICAL WSL FIX: Disable SDMA to prevent "Out of Resources" crash
      - HSA_ENABLE_SDMA=0
      
      # 4. Debugging: Shows us exactly what ROCm detects
      #- AMD_LOG_LEVEL=3

    devices:
      # Passes the Windows GPU interface to the container
      - /dev/dxg:/dev/dxg
      # Map dxg to kfd as well, as some libraries look for /dev/kfd by default
      - /dev/dxg:/dev/kfd

    volumes:
      # Map your local project folder
      - .:/app
      
      # BRIDGE: These two lines let the container talk to the Windows Kernel
      # We ONLY mount the Windows core libs. We do NOT mount libhsa-runtime,
      # because our Dockerfile now provides the correct one internally.
      - /usr/lib/wsl/lib/libdxcore.so:/usr/lib/libdxcore.so
      - /usr/lib/wsl/lib/libd3d12.so:/usr/lib/libd3d12.so

    working_dir: /app
    
    # Security settings required for direct hardware access
    security_opt:
      - seccomp:unconfined
    group_add:
      - video
      - render

    # Keep container alive so you can exec in and run scripts manually
    command: ["sleep", "infinity"]